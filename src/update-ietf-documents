#!/usr/bin/env bash

REFERENCES=~/src/papers/Referenzarchiv.bib
DOCUMENTS=`grep -E "^@[a-zA-Z]*{[ \t].*,.*$" "${REFERENCES}" | sed -e "s/,//g" | awk '{ print $2; }' | grep -E "^RFC|^draft"`
OUTPUT_FILE="updated.bib"
OUTPUT_FILE3="results.bib"
PARALLEL=32


# echo "Step 1: Fetching metadata ..."
# echo "$DOCUMENTS" | (
#    while read name ; do
#       if [[ "${name}" =~ ^(RFC[0-9]+$)|(draft-[a-z].*$) ]] ; then
#          # echo >&2 "Processing ${name} ..."
#          echo "./ietf2bibtex --quiet \"${name}\" >${name}.bib"
#       else
#          echo "Skipping ${name}"
#       fi
#    done
# ) | parallel -j${PARALLEL}
#
# echo "Step 2: Fetching documents ..."
# echo "$DOCUMENTS" | (
#    while read name ; do
#       echo "./bibtexconv ${name}.bib -export-to-bibtex=${name}.bib2 -check-urls -only-check-new-urls -non-interactive"
#    done
# ) | parallel -j${PARALLEL}
#
# echo "Step 3: Collecting results ..."
# cat ${REFERENCES} >${OUTPUT_FILE}
# echo "$DOCUMENTS" | (
#    while read name ; do
#       cat ${name}.bib2 >>${OUTPUT_FILE}
#       rm -f ${name}.bib ${name}.bib2
#    done
# )
./bibtexconv ${OUTPUT_FILE} -export-to-bibtex=${OUTPUT_FILE3} -non-interactive
echo "Done."


diff ~/src/papers/Referenzarchiv.bib ${OUTPUT_FILE3} | grep -v url.checked | grep -v -E '^[[:alnum:]]+' | grep -v "^---$"
colordiff ${REFERENCES} ${OUTPUT_FILE3} |grep author|grep -B1 '>'
